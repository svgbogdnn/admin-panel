## Экспорт (страница и бекенд-эндпоинт)

### Что экспортирует

В проекте экспорт — это выгрузка **посещаемости** по выбранным фильтрам (курс / студент / диапазон дат; на фронте ещё есть ID занятия и комментарий). На уровне данных выгрузка строится из связки **Attendance ↔ Lesson ↔ Course ↔ User**. 

---

### Бекенд: `/api/v1/export/attendance`

**Эндпоинт:** `GET /export/attendance` 

**Параметры:**

* `response_format`: строго `csv` или `json` (сейчас задано через `Query(..., regex="^(csv|json)$")`). 
  Примечание: в новых версиях FastAPI параметр `regex` считается устаревшим, рекомендуется `pattern`. ([FastAPI][1])
* `course_id`, `student_id`, `from_date`, `to_date` 

**Контроль доступа/скоуп данных:**

* **Teacher** видит только записи по курсам, где он назначен преподавателем (`Course.teacher_id == current_user.id`). 
* **Student** (любой, кто не admin/teacher) принудительно ограничивается только своими записями (`Attendance.student_id == current_user.id`), и даже если он передаст `student_id`, он обнуляется. 

**Формат JSON:**
Возвращается массив объектов с ключами:

* `ФИО студента`, `Курс`, `Дата занятия`, `Статус` 

**Формат CSV:**
Генерируется CSV (через `csv.writer` в `StringIO`) и отдаётся как `StreamingResponse` с:

* `media_type="text/csv"`
* `Content-Disposition: attachment; filename=attendance_export.csv` 

Именно `Content-Disposition` задаёт браузеру поведение “скачать файл” и имя файла; это типовой подход для стриминговых ответов. ([Stack Overflow][2])

---

### Фронтенд: страница `ExportPage.tsx`

На текущий момент **страница экспорта делает выгрузку на клиенте**, а не через бекенд `/export/attendance`:

1. **Собирает фильтры** (курс, ID занятия, студент, период, тип экспорта csv/json). 
2. Нажатие “Сформировать/Скачать” вызывает `getAttendance(...)` и получает записи посещаемости. 
3. Строит “плоские” строки `ExportRow` (курс, дата, lesson_id, студент, статус, комментарий). 
4. Для CSV — формирует CSV-строку (с экранированием кавычек/запятых) + добавляет BOM `\ufeff` для корректного открытия в Excel, затем скачивает через `Blob + URL.createObjectURL`.
   Это стандартный браузерный способ скачивания файлов. ([Gist][3])

При этом **API-метод `exportAttendance()` (axios `responseType: "blob"`) у тебя тоже есть**, но **на странице он, судя по коду, не используется** (страница берёт данные через `/attendance` и сама собирает файл).

---

### Итого по “как работает экспорт” в проекте (1 абзац)

Экспорт реализован в двух слоях: на бекенде есть отдельный защищённый эндпоинт `GET /export/attendance`, который по ролям ограничивает доступ к данным и отдаёт либо JSON, либо CSV как файл (StreamingResponse с `Content-Disposition`).  На фронте же текущая страница `ExportPage` фактически делает экспорт “в браузере”: запрашивает посещаемость через `/attendance`, строит строки, показывает превью и скачивает CSV/JSON через Blob-ссылку.

