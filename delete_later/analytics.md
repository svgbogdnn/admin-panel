### Аналитика в проекте (модуль и как работает ML-часть)

В аналитике у тебя два ключевых API-эндпоинта: **overview** (сводные метрики/графики) и **risk** (оценка “риска прогула” с ML-моделью и fallback-алгоритмом).  

---

## 1) Overview: сводка и “дашборд”

**Эндпоинт:** `GET /api/v1/analytics/overview` возвращает объект `AnalyticsOverview`. В нём есть:

* `summary` (кол-во курсов/уроков, посещаемость total/attended/attendance_rate, средняя оценка фидбэка и кол-во фидбэков) 
* `timeseries` (временной ряд по датам: total/attended/attendance_rate) 
* `rating_distribution` (распределение оценок 1–5) 
* `top_absent_students` (топ студентов по пропускам: absent/total/absent_rate) 
* `course_summary` (таблица по курсам: уроки, attendance_rate, avg feedback, count feedback) 
  Также приходит `role` и `scope` (overall/personal) — это используется на фронте для режима отображения.  

На фронтенде `AnalyticsPage.tsx` забирает это через `getAnalyticsOverview()` и рисует KPI/таблицы/графики.  

---

## 2) Risk: “ML-модель риска прогула” (самое важное)

**Эндпоинт:** `GET /api/v1/analytics/risk` возвращает `AnalyticsRiskResponse` со списком строк риска по студентам/курсам.

### 2.1. Что именно предсказывается

Цель (`label`) — **прогул на следующей записи посещаемости**:

* `y = 1`, если следующий статус `"absent"`, иначе `0`. 

Результат для каждой пары *(student_id, course_id)*:

* `risk_absent_next` — вероятность (0..1)
* `model` — `"logistic_regression"` или `"heuristic"`
* `confidence` — оценка уверенности (эвристическая)

### 2.2. Какие фичи (признаки) строятся

Фичи рассчитываются из “окна” последних посещений и всей истории:

* доля `absent/late/excused` в окне (recent rates)
* `absent_streak` — текущая серия прогулов подряд
* доли `absent/late/excused` по всей истории (overall rates)
* длина истории и длина окна

Список фич возвращается клиенту в `features`.

### 2.3. Как формируется обучающая выборка

Для каждой пары *(student, course)* берётся последовательность статусов, сортированная по датам; далее для каждого момента времени `t` строится окно длиной `k` (`k` параметр запроса) и метка “следующая запись absent/нет”.
Параметры защищены ограничениями: `k` принудительно в диапазон **2..20**, `limit` в **1..500**. 

### 2.4. Какая модель используется

Если данных достаточно (минимум **30 обучающих примеров** и хотя бы **2 класса** в `y`), код пытается обучить **Logistic Regression** из scikit-learn в пайплайне со стандартизацией:

* `Pipeline([StandardScaler(), LogisticRegression(max_iter=2000, class_weight="balanced", solver="liblinear")])`
  `StandardScaler` — нормализация признаков; `class_weight="balanced"` помогает при дисбалансе классов; `predict_proba()` используется, чтобы получить вероятность “absent”. ([scikit-learn.org][1])

### 2.5. Fallback, если ML не обучился

Если данных мало или scikit-learn недоступен/упал импорт, включается **heuristic**: сглаженная оценка вероятности на основе доли прогулов в последнем окне (с псевдосчётчиками), затем probability ограничивается в пределах `[0.005, 0.995]`.

**Важно:** если у тебя в `requirements.txt` не установлен `scikit-learn`, модель почти всегда будет уходить в `heuristic` (обучение внутри `try/except`). 

### 2.6. Роли и “скоуп” (чьи данные считаются)

`scope=auto|overall|personal`:

* для **admin/teacher** `auto` превращается в `overall`
* для **student** всегда принудительно `personal`
  Плюс, выбор курсов ограничивается правами (teacher — только свои курсы). 

---

## 3) Как это выглядит на странице Analytics (фронт)

`AnalyticsPage.tsx` вызывает:

* `getAnalyticsOverview()` — графики/сводка
* `getAnalyticsRisk()` — таблица риска, раскраска по “бендам” (минимальный/низкий/средний/повышенный/высокий).
