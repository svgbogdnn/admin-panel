# Экспорт

Раздел **«Экспорт»** предназначен для выгрузки данных посещаемости в файл (как правило, **CSV** или **JSON**) с возможностью **отфильтровать** выборку и **предварительно посмотреть** результат перед скачиванием.

Примеры UI:

* `imgs/Export/Export1.png`
* `imgs/Export/Export3.png`
* `imgs/Export/Export4.png`

---

### Что именно экспортируется

Базовая сущность экспорта — **строки посещаемости** (attendance records), которые логически связывают:

* **Курс** (course)
* **Урок/занятие** (lesson) — обычно содержит дату/аудиторию/тему
* **Студента** (student)
* **Статус посещения** (например: присутствовал/отсутствовал/опоздал)
* **Комментарий/примечание** (если предусмотрено)

Идея простая: экспорт — это “таблица”, где каждая строка отвечает на вопрос:
**кто** (student) **на каком занятии** (lesson) **по какому курсу** (course) **с каким статусом** (status) и **каким комментарием**.

---

### Пользовательский сценарий

Типовой сценарий работы с экспортом выглядит так:

1. Открыть раздел **«Экспорт»**.
   Пример: `imgs/Export/Export1.png`

2. Указать фильтры (минимально — курс, остальное опционально):

   * **Курс** (обязательный фильтр почти всегда, иначе объём данных может быть огромным)
   * **Урок** (если нужно выгрузить конкретное занятие)
   * **Студент** (если нужна выгрузка по одному человеку)
   * **Диапазон дат** (самый частый фильтр на практике)
   * **Тип данных/формат файла**: `CSV` или `JSON`

3. Нажать **«Сформировать»** (или аналогичную кнопку):

   * UI делает запрос за данными (или инициирует формирование на сервере),
   * показывает **превью**: таблица первых N строк + счётчики “сколько записей найдено”.

4. Нажать **«Скачать»**:

   * браузер скачивает файл с понятным названием (например `attendance_export_YYYYMMDD_HHMMSS.csv/json`).

5. (Опционально) Нажать **«Очистить»**:

   * сброс формы фильтров и результата.

---

### Форматы выгрузки

#### CSV

CSV удобен для Excel/Google Sheets и быстрой проверки.

Обычно CSV включает:

* строку заголовков (колонки),
* строки данных.

Практический нюанс: если в данных есть кириллица, корректность открытия в Excel зависит от кодировки/префикса. Самый совместимый вариант — **UTF-8** (часто добавляют BOM для Excel-совместимости — зависит от реализации).

#### JSON

JSON удобен для интеграций и программной обработки (скрипты, аналитика, загрузка в другие сервисы).

Пример того, как это выглядит “в файле” — `imgs/Export/Export2.png`.

---

### Как это работает технически

#### Вариант A: сервер формирует файл и отдаёт “как вложение”

Это типичный enterprise-паттерн: фронт запрашивает `GET/POST`, сервер возвращает файл.

Ключевые требования:

1. **Правильные заголовки ответа**:

   * `Content-Disposition: attachment; filename="..."` — чтобы браузер скачивал файл, а не пытался отобразить его inline. ([MDN Web Docs][1])
   * корректный `Content-Type` (например `text/csv; charset=utf-8` для CSV и `application/json; charset=utf-8` для JSON).

2. **Корректная доставка больших файлов**:

   * если файл может быть большим, его лучше отдавать потоково (streaming) или через специализированный response-класс.
   * В FastAPI для этого применяются стандартные классы ответов (в т.ч. для файлов/потоков). ([FastAPI][2])

3. **Безопасное имя файла**:

   * имя формируется без “опасных” символов,
   * расширение соответствует формату.

По сути: фронт делает запрос на эндпоинт экспорта, сервер применяет фильтры, собирает выборку (JOIN по курсам/урокам/пользователям/посещаемости), сериализует в CSV/JSON и возвращает ответ с `Content-Disposition: attachment`.

---

#### Вариант B: фронт получает данные и сам делает файл (Blob → download)

Иногда удобнее забрать данные JSON-ом (обычным API) и сформировать файл на клиенте. Это особенно удобно, когда:

* объём данных умеренный,
* нужен мгновенный preview теми же данными,
* проще поддерживать 2 формата (CSV/JSON) в UI.

Технический стандарт для скачивания на фронте:

1. сформировать `Blob` из строки/байтов,
2. создать ссылку через `URL.createObjectURL(blob)`,
3. “кликнуть” по `<a download="...">`.

`URL.createObjectURL()` — стандартный Web API для таких сценариев. ([MDN Web Docs][3])

---

### Авторизация и доступы

Экспорт относится к данным пользователей, поэтому практически всегда защищён авторизацией:

* фронт отправляет токен (обычно `Authorization: Bearer <token>`)
* сервер проверяет токен и роль пользователя
* дальше применяется логика доступа (RBAC), типично:

  * **Администратор**: может экспортировать по любым курсам/студентам
  * **Преподаватель**: только свои курсы/занятия
  * **Студент**: (если предусмотрено) только свою посещаемость

Это важно не только “для галочки”: иначе экспорт становится самым простым способом утечки данных.

---

### Где это видно в интерфейсе

* Базовый экран экспорта и фильтры: `imgs/Export/Export1.png`
* Пример JSON-выгрузки: `imgs/Export/Export2.png`
* Пример результата/состояния после формирования: `imgs/Export/Export3.png`, `imgs/Export/Export4.png`

[1]: https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Reference/Headers/Content-Disposition "Content-Disposition - HTTP | MDN"
[2]: https://fastapi.tiangolo.com/reference/responses/ "Custom Response Classes - File, HTML, Redirect, Streaming, etc. - FastAPI"
[3]: https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL_static "URL: createObjectURL() static method - Web APIs | MDN"
